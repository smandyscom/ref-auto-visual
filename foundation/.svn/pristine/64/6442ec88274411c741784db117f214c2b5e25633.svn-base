
Imports Automation
Imports Automation.Components.Services
Public Class userControlSystem
    Property SystemReference As systemControlPrototype
        Get
            Return __systemReference
        End Get
        Set(value As systemControlPrototype)
            If (value IsNot Nothing) Then
                __systemReference = value
                loadSystem(Me, Nothing)
            End If
        End Set
    End Property
    Protected WithEvents __systemReference As systemControlPrototype
    Protected IsReentry As Boolean = False

    'Private Sub messagePostHandler(ByVal sender As Object, ByVal e As messagePackageEventArg)

    '    Me.BeginInvoke(New Action(Sub()

    '                                  RichTextBoxMessage.Text += (e.Message.ToString() + Environment.NewLine())


    '                                  ' keep scoll on bottom
    '                                  RichTextBoxMessage.SelectionStart = TabPageMessage.Text.Length
    '                                  RichTextBoxMessage.ScrollToCaret()

    '                              End Sub))
    'End Sub

    Private userControlControlFlags As userControlFlags = New userControlFlags()
    Private userControlStatusFlags As userControlFlags = New userControlFlags()

    Private Sub loadSystem(sender As Object, e As EventArgs) Handles MyBase.Load
        If (__systemReference Is Nothing) Then
            Exit Sub
        End If

        'System Name
        GroupBoxSystemName.Text = __systemReference.ToString()

        'loading flags into tables
        userControlControlFlags.FlagsReference = __systemReference.relatedFlags
        TabPageControlFlags.Controls.Add(userControlControlFlags)
        'userControlStatusFlags.FlagsReference = __systemReference.statusFlagsReference 'status reference truncated , Hsien , 2014.01.07
        TabPageStatusFlags.Controls.Add(userControlStatusFlags)

        'link alarm user control
        UserControlAlarmObject.AlarmReference = __systemReference.CentralAlarmObject

        If (__systemReference.CentralMessenger Is Nothing) Then
            RichTextBoxMessage.Text += "Message Manager Not Linked"
        Else
            'AddHandler systemReference.CentralMessenger.MessagePoped, AddressOf Me.messagePostHandler
        End If

        '
        Me.PropertyGridSystem.SelectedObject = __systemReference

        ' load components
        '-------------------------------
        ' loading components into tables
        '-------------------------------
        TableLayoutPanelComponents.Controls.Clear()
        Dim componentsControl As UserControlComponent
        For Each comp As driveBase In __systemReference.ComponentsIncluded
            componentsControl = New UserControlComponent
            componentsControl.componentReference = comp
            TableLayoutPanelComponents.Controls.Add(componentsControl)
        Next

        'AddHandler systemReference.ProcessProgressed, AddressOf systemRefresh
        'AddHandler Me.ParentForm.FormClosing, AddressOf Me.removeRefreshHandler

    End Sub

    'Private Sub unloadSystem(sender As Object, e As EventArgs)
    '    '-------
    '    ' try to fix handler call afer handle destroyed issue
    '    '-------
    '    If (systemReference Is Nothing) Then
    '        Exit Sub
    '    End If

    '    RemoveHandler systemReference.ProcessProgressed, AddressOf Me.systemRefresh
    'End Sub

    Private Sub systemRefresh(ByVal sender As Object, ByVal e As EventArgs) Handles TimerRefresh.Tick
        'Handles TimerRefresh.Tick
        '---------------
        '   Used to refresh GUI
        '---------------
        If (Me.IsDisposed) Then
            Exit Sub
        End If

        'reject
        'If (IsReentry) Then
        '    Exit Sub
        'End If

        'IsReentry = True

        'Me.BeginInvoke(New Action(Sub()
        '                         SuspendLayout()


        Me.PropertyGridSystem.Refresh()

        '---------
        ' Flag Status Refresh
        '---------
        userControlControlFlags.Refresh()
        userControlStatusFlags.Refresh()

        For Each uc As Control In TableLayoutPanelComponents.Controls
            uc.Refresh()
        Next

        ResumeLayout()

        'IsReentry = False

        'End Sub))
    End Sub
    Private Sub controlEnter(sender As Object, e As EventArgs) Handles Me.Enter

        TimerRefresh.Enabled = True
        'AddHandler systemReference.ProcessProgressed, AddressOf systemRefresh
    End Sub
    Private Sub controlLeave(sender As Object, e As EventArgs) Handles Me.Leave
        TimerRefresh.Enabled = False
        ' avoid to handle event after uc closed

        'RemoveHandler systemReference.ProcessProgressed, AddressOf Me.systemRefresh
    End Sub

    Private Sub removeRefreshHandler(ByVal sender As Object, ByVal e As EventArgs) Handles MyBase.Disposed
        'RemoveHandler systemReference.ProcessProgressed, AddressOf Me.systemRefresh
    End Sub

End Class
