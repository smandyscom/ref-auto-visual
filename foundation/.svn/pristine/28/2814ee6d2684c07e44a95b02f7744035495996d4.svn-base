Imports Automation
Imports Automation.Components.Services
Imports Automation.Components.CommandStateMachine
Imports Automation.Components

Public Enum LoadConveyerUsedPositions
    MOTOR_POSITION_1
    'MOTOR_POSITION_2
End Enum

Public Class SensorInfo
    Public sensor As sensorControl
    Public sw As Integer
    Public status As Integer
End Class
Public Class ActuatorInfo
    Public Actuator As ULong
    Public sw As Integer
End Class

Public Class CassetteLoad : Inherits systemControlPrototype
    Implements IFinishableStation
    Public Enum CheckCasStyleSenIndex
        SEN_1
        SEN_2
        SEN_3
        SEN_4   '   Hsien , 2015.07.03 , added 
        SEN_5   '   Hsien , 2016.03.24 , expand
    End Enum

    Public Property _FinishableFlag As New flagController(Of IFinishableStation.controlFlags) Implements IFinishableStation.FinishableFlags
    Public Property _UpstreamStation As List(Of IFinishableStation) Implements IFinishableStation.UpstreamStations

    Public extensionSequence As Func(Of Boolean) = Function() (True)     'Hsien , used to attach extension sequence , i.e read RFID on ready position
    Public loadFlags As flagController(Of flagsInLoaderUnloader)

    Public timer As singleTimer = New singleTimer With {.TimerGoal = New TimeSpan(0, 0, 5)}

    'Cassette:Cas    UD:Up Down    Position:Pos    Sensor:Sen
    Public IN_Stopper1 As cylinderControl = New cylinderControl With {.IsEnabled = True}
    Public IN_Stopper2 As cylinderControl = New cylinderControl With {.IsEnabled = True}

    'Public IN_ConveyerOverrideSen As sensorControl = New sensorControl
    Public IN_CasStyleCheckSen As SensorInfo() = New SensorInfo(4) {New SensorInfo With {.sw = IS_OFF},
                                                                    New SensorInfo With {.sw = IS_OFF},
                                                                    New SensorInfo With {.sw = IS_OFF},
                                                                    New SensorInfo With {.sw = IS_OFF},
                                                                    New SensorInfo With {.sw = IS_OFF}} 'Hsen , pre-allocating , 2015.06.26
    Private SensorIndex As Integer


    Public IN_ConveyerMotor As IDrivable = New motorControlDrivable With {.IsEnabled = True}   '載出馬達 , Hsien , regular the data type , 2015.06.04

    Public IN_ConveyerPosSen1 As sensorControl = New sensorControl '載出卡匣位置確認感測器1    '
    Public IN_ConveyerPosSen2 As sensorControl = New sensorControl '載出卡匣位置確認感測器2    'on Stopper 1
    Public IN_ConveyerPosSen3 As sensorControl = New sensorControl '載出卡匣位置確認感測器3    'on Stopper 2


    Public LP_LoadConveyerMove As ULong

    Public Function stateIgnite() As Integer
        If _FinishableFlag.viewFlag(IFinishableStation.controlFlags.COMMAND_IGNITE) = True Then
            _FinishableFlag.writeFlag(IFinishableStation.controlFlags.COMMAND_IGNITE, False)
            systemMainState = systemStatesEnum.EXECUTE
        End If
        Return 0
    End Function

    Public Function stateExecuteMethod1() As Integer

        '==========================================
        ' Cassette Direction   >>>>>>>>>>>>>
        '             Stopper1       Stopper2
        'Sen1          Sen2           Sen3
        '==========================================
        Select Case systemSubState
            Case 0 '檢查料匣備便旗標是否去能,檢查是否有料匣或檢查是否有按下入卡匣鈕


                If Not loadFlags.viewFlag(flagsInLoaderUnloader.CasOn_IN_ConveyerReady_f) And
                       loadFlags.viewFlag(flagsInLoaderUnloader.Start_f) And
                       (Not loadFlags.viewFlag(flagsInLoaderUnloader.LoadButtonBusy_f)) And
                       (IN_ConveyerPosSen2.OnTimer.TimeElapsed.TotalMilliseconds >= 100) Then

                    '不在手動載入模式下

                    loadFlags.writeFlag(flagsInLoaderUnloader.LoadButtonDisable_f, True) '使載入按鈕失效

                    systemSubState = 100

                End If

                sensorControl.activateSensorControl(IN_ConveyerPosSen2, systemSubState = 0)

            Case 5 '輸送帶開始移動料匣
                If (IN_ConveyerMotor.drive(motorControl.motorCommandEnum.JOG, LoadConveyerUsedPositions.MOTOR_POSITION_1) =
                     IDrivable.endStatus.EXECUTION_END) Then
                    timer.TimerGoal = New TimeSpan(0, 0, 10)
                    timer.IsEnabled = True    'restart
                    systemSubState = 10
                End If
            Case 10 '檢查Sen2是否有卡匣到達


                If IN_ConveyerPosSen2.OnTimer.TimeElapsed.TotalMilliseconds > 100 Then
                    timer.TimerGoal = New TimeSpan(0, 0, 1)
                    timer.IsEnabled = True    'restart
                    loadFlags.writeFlag(flagsInLoaderUnloader.LoadButtonDisable_f, True) '使載入按鈕失效

                    systemSubState = 20

                ElseIf (timer.IsTimerTicked) Then

                    systemSubState = 15

                End If

                sensorControl.activateSensorControl(IN_ConveyerPosSen2, systemSubState = 10)

            Case 15 '時間到未到達Sen2輸送帶馬達停止
                If IN_ConveyerMotor.drive(motorControl.motorCommandEnum.STOP_SLOW_DOWN) =
                    IDrivable.endStatus.EXECUTION_END Then

                    loadFlags.writeFlag(flagsInLoaderUnloader.LoadButtonDisable_f, False) '手動鈕致能
                    systemSubState = 0

                End If
            Case 20 '輸送帶馬達停止
                If timer.IsTimerTicked AndAlso
                    IN_ConveyerMotor.drive(motorControl.motorCommandEnum.STOP_SLOW_DOWN) = IDrivable.endStatus.EXECUTION_END Then
                    systemSubState = 100
                End If
            Case 100 '使氣缸下降
                If IN_Stopper1.drive(cylinderControl.cylinderCommandEnum.GO_OFF_END) = cylinderControl.statusEnum.EXECUTION_END Then
                    systemSubState = 160
                End If
            Case 160 '輸送帶開始移動
                If (IN_ConveyerMotor.drive(motorControl.motorCommandEnum.JOG, LoadConveyerUsedPositions.MOTOR_POSITION_1) =
                    IDrivable.endStatus.EXECUTION_END) Then
                    timer.TimerGoal = New TimeSpan(0, 0, 10)
                    timer.IsEnabled = True    'restart
                    systemSubState = 170
                End If
            Case 170 '如果料匣到達入料輸送帶最前端Sen3
                If IN_ConveyerPosSen3.IsSensorCovered Then
                    timer.TimerGoal = New TimeSpan(0, 0, 1)
                    timer.IsEnabled = True    'restart
                    systemSubState = 280
                ElseIf timer.IsTimerTicked Then
                    '如果逾時到錯誤檢查程序
                    systemSubState = 180
                End If
            Case 180 '輸送帶馬達停止
                If IN_ConveyerMotor.drive(motorControl.motorCommandEnum.STOP_SLOW_DOWN) =
                    IDrivable.endStatus.EXECUTION_END Then
                    systemSubState = 190
                End If
            Case 190 '產生錯誤
                Dim ap As New alarmContentSensor
                With ap
                    .Sender = Me
                    .Inputs = IN_ConveyerPosSen3.InputBit
                    .PossibleResponse = alarmContextBase.responseWays.RETRY Or alarmContextBase.responseWays.IGNORE
                    .Reason = alarmContentSensor.alarmReasonSensor.SHOULD_BE_ON
                    .CallbackResponse(alarmContextBase.responseWays.RETRY) = Function() As Boolean
                                                                                 systemSubState = 160
                                                                                 Return True
                                                                             End Function
                    .CallbackResponse(alarmContextBase.responseWays.IGNORE) = Function() As Boolean
                                                                                  systemSubState = 200
                                                                                  Return True
                                                                              End Function
                    CentralAlarmObject.raisingAlarm(ap)
                End With
            Case 200 '逾時忽略後使氣缸上升
                If IN_Stopper1.drive(cylinderControl.cylinderCommandEnum.GO_ON_END) = cylinderControl.statusEnum.EXECUTION_END Then
                    loadFlags.writeFlag(flagsInLoaderUnloader.LoadButtonDisable_f, False) '使載入按鈕致能
                    systemSubState = 0
                End If
            Case 280 '延遲一段時間，停止運轉
                If timer.IsTimerTicked Then
                    If IN_ConveyerMotor.drive(motorControl.motorCommandEnum.STOP_SLOW_DOWN) = motorControl.statusEnum.EXECUTION_END Then
                        systemSubState = 290
                    End If
                End If
                '----------IN_CasStyleCheckSen----------
            Case 290
                SensorIndex = CheckCasStyleSenIndex.SEN_1
                systemSubState = 295
            Case 295 '判別感測器是否要檢查On或是Off
                If (IN_CasStyleCheckSen(SensorIndex).sw = IS_ON) Then
                    timer.TimerGoal = New TimeSpan(0, 0, 2)
                    timer.IsEnabled = True    'restart
                    systemSubState = 300
                Else
                    systemSubState = 330
                End If
            Case 300 '檢查料匣形式防呆感測器
                If IN_CasStyleCheckSen(SensorIndex).status = IS_ON And IN_CasStyleCheckSen(SensorIndex).sensor.IsSensorCovered Then
                    systemSubState = 330
                ElseIf IN_CasStyleCheckSen(SensorIndex).status = IS_OFF And (Not IN_CasStyleCheckSen(SensorIndex).sensor.IsSensorCovered) Then
                    systemSubState = 330
                Else
                    If timer.IsTimerTicked Then
                        Dim ap As New alarmContentSensor
                        With ap
                            .Sender = Me
                            .Inputs = IN_CasStyleCheckSen(SensorIndex).sensor.InputBit
                            .PossibleResponse = alarmContextBase.responseWays.RETRY
                            If IN_CasStyleCheckSen(SensorIndex).status = IS_ON Then .Reason = alarmContentSensor.alarmReasonSensor.SHOULD_BE_ON
                            If IN_CasStyleCheckSen(SensorIndex).status = IS_OFF Then .Reason = alarmContentSensor.alarmReasonSensor.SHOULD_BE_OFF
                            .CallbackResponse(alarmContextBase.responseWays.RETRY) = Function() As Boolean
                                                                                         systemSubState = 290
                                                                                         Return True
                                                                                     End Function
                            CentralAlarmObject.raisingAlarm(ap)
                        End With
                    End If
                End If
            Case 330
                SensorIndex = SensorIndex + 1
                'Hsien , follow the enum length adaptlly , 2015.10.06
                If SensorIndex > [Enum].GetValues(GetType(CheckCasStyleSenIndex)).Length - 1 Then
                    'end condition
                    systemSubState = 500
                Else
                    systemSubState = 295
                End If
                '--------------------------------------------------------
            Case 500 '上升擋料匣
                If IN_Stopper1.drive(cylinderControl.cylinderCommandEnum.GO_ON_END) = cylinderControl.statusEnum.EXECUTION_END Then
                    systemSubState = 510
                End If
            Case 510
                If (extensionSequence()) Then
                    'Hsien , used to call extension sequence  , i.e rfid read
                    systemSubState = 560
                End If
            Case 560
                loadFlags.writeFlag(flagsInLoaderUnloader.CasOn_IN_ConveyerReady_f, True)
                loadFlags.writeFlag(flagsInLoaderUnloader.LoadButtonDisable_f, False) '手動鈕致能
                systemSubState = 0
        End Select

        Return 0
    End Function
    Public Function stateExecuteMethod2() As Integer

        '==========================================
        ' Cassette Direction   >>>>>>>>>>>>>
        '             Stopper1       Stopper2
        'Sen1          Sen2           Sen3
        '==========================================
        Select Case systemSubState
            Case 0 '檢查料匣備便旗標是否去能
                If Not loadFlags.viewFlag(flagsInLoaderUnloader.CasOn_IN_ConveyerReady_f) And _
                       loadFlags.viewFlag(flagsInLoaderUnloader.Start_f) Then
                    systemSubState = 10
                End If
            Case 10 '使氣缸下降
                If IN_Stopper1.drive(cylinderControl.cylinderCommandEnum.GO_OFF_END) = cylinderControl.statusEnum.EXECUTION_END Then
                    systemSubState = 20
                End If
            Case 20 '檢查是否有料匣或檢查是否有按下入卡匣鈕

                If Not loadFlags.viewFlag(flagsInLoaderUnloader.LoadButtonBusy_f) Then '不在手動載入模式下
                    If IN_ConveyerPosSen3.OnTimer.TimeElapsed.TotalMilliseconds >= 100 Then
                        loadFlags.writeFlag(flagsInLoaderUnloader.LoadButtonDisable_f, True) '使載入按鈕失效
                        systemSubState = 290 '卡匣到位正確位置,檢查卡匣型式是否正確
                    ElseIf IN_ConveyerPosSen1.OnTimer.TimeElapsed.TotalMilliseconds >= 100 Or IN_ConveyerPosSen2.OnTimer.TimeElapsed.TotalMilliseconds >= 100 Then
                        loadFlags.writeFlag(flagsInLoaderUnloader.LoadButtonDisable_f, True) '使載入按鈕失效
                        systemSubState = 160 '使卡匣載入至正確位置
                    End If
                End If

                sensorControl.activateSensorControl(IN_ConveyerPosSen1, systemSubState = 20)
                sensorControl.activateSensorControl(IN_ConveyerPosSen2, systemSubState = 20)
                sensorControl.activateSensorControl(IN_ConveyerPosSen3, systemSubState = 20)


            Case 160 '輸送帶開始移動
                If (IN_ConveyerMotor.drive(motorControl.motorCommandEnum.JOG, LoadConveyerUsedPositions.MOTOR_POSITION_1) =
                    IDrivable.endStatus.EXECUTION_END) Then
                    timer.TimerGoal = New TimeSpan(0, 0, 30)
                    timer.IsEnabled = True    'restart
                    systemSubState = 170
                End If
            Case 170 '如果料匣到達入料輸送帶最前端Sen3
                If IN_ConveyerPosSen3.IsSensorCovered Then
                    timer.TimerGoal = New TimeSpan(0, 0, 2)
                    timer.IsEnabled = True    'restart
                    systemSubState = 280
                ElseIf timer.IsTimerTicked Then
                        '如果逾時到錯誤檢查程序
                        systemSubState = 180
                End If
            Case 180 '輸送帶馬達停止
                If IN_ConveyerMotor.drive(motorControl.motorCommandEnum.STOP_SLOW_DOWN) =
                    IDrivable.endStatus.EXECUTION_END Then
                    systemSubState = 190
                End If
            Case 190 '產生錯誤
                Dim ap As New alarmContentSensor
                With ap
                    .Sender = Me
                    .Inputs = IN_ConveyerPosSen3.InputBit
                    .PossibleResponse = alarmContextBase.responseWays.RETRY Or alarmContextBase.responseWays.IGNORE
                    .Reason = alarmContentSensor.alarmReasonSensor.SHOULD_BE_ON
                    .CallbackResponse(alarmContextBase.responseWays.RETRY) = Function() As Boolean
                                                                                 systemSubState = 160
                                                                                 Return True
                                                                             End Function
                    .CallbackResponse(alarmContextBase.responseWays.IGNORE) = Function() As Boolean
                                                                                  systemSubState = 200
                                                                                  Return True
                                                                              End Function
                    CentralAlarmObject.raisingAlarm(ap)
                End With
            Case 200 '逾時忽略
                loadFlags.writeFlag(flagsInLoaderUnloader.LoadButtonDisable_f, False) '使載入按鈕致能
                systemSubState = 0
            Case 280 '延遲一段時間，停止運轉
                If timer.IsTimerTicked Then
                    If IN_ConveyerMotor.drive(motorControl.motorCommandEnum.STOP_SLOW_DOWN) = motorControl.statusEnum.EXECUTION_END Then
                        systemSubState = 290
                    End If
                End If
                '----------IN_CasStyleCheckSen----------
            Case 290
                'default : accepted cassette
                loadFlags.setFlag(flagsInLoaderUnloader.IsCaseetteAcceptable_f)

                SensorIndex = CheckCasStyleSenIndex.SEN_1
                systemSubState = 295
            Case 295 '判別感測器是否要檢查On或是Off
                If (IN_CasStyleCheckSen(SensorIndex).sw = IS_ON) Then
                    timer.TimerGoal = New TimeSpan(0, 0, 2)
                    timer.IsEnabled = True    'restart
                    systemSubState = 300
                Else
                    systemSubState = 330
                End If
            Case 300 '檢查料匣形式防呆感測器
                If IN_CasStyleCheckSen(SensorIndex).status = IS_ON And IN_CasStyleCheckSen(SensorIndex).sensor.IsSensorCovered Then
                    systemSubState = 330
                ElseIf IN_CasStyleCheckSen(SensorIndex).status = IS_OFF And (Not IN_CasStyleCheckSen(SensorIndex).sensor.IsSensorCovered) Then
                    systemSubState = 330
                ElseIf timer.IsTimerTicked Then
                    Dim ap As New alarmContentSensor
                    With ap
                        .Sender = Me
                        .Inputs = IN_CasStyleCheckSen(SensorIndex).sensor.InputBit
                        .PossibleResponse = alarmContextBase.responseWays.RETRY Or alarmContextBase.responseWays.IGNORE
                        If IN_CasStyleCheckSen(SensorIndex).status = IS_ON Then .Reason = alarmContentSensor.alarmReasonSensor.SHOULD_BE_ON
                        If IN_CasStyleCheckSen(SensorIndex).status = IS_OFF Then .Reason = alarmContentSensor.alarmReasonSensor.SHOULD_BE_OFF
                        .CallbackResponse(alarmContextBase.responseWays.RETRY) = Function() As Boolean
                                                                                     systemSubState = 290
                                                                                     Return True
                                                                                 End Function
                        .CallbackResponse(alarmContextBase.responseWays.IGNORE) = Function() As Boolean
                                                                                      'let cassette go , and eject , Hsien , 2015.10.06
                                                                                      loadFlags.resetFlag(flagsInLoaderUnloader.IsCaseetteAcceptable_f)
                                                                                      systemSubState = 500
                                                                                      Return True
                                                                                  End Function
                        .AdditionalInfo = "卡匣形式偵測錯誤"
                        CentralAlarmObject.raisingAlarm(ap)
                    End With
                End If
            Case 330
                SensorIndex = SensorIndex + 1
                'Hsien , follow the enum length adaptlly , 2015.10.06
                If SensorIndex > [Enum].GetValues(GetType(CheckCasStyleSenIndex)).Length - 1 Then
                    systemSubState = 500
                Else
                    systemSubState = 295
                End If
                '--------------------------------------------------------
            Case 500 '上升擋料匣
                If IN_Stopper1.drive(cylinderControl.cylinderCommandEnum.GO_ON_END) = cylinderControl.statusEnum.EXECUTION_END Then
                    systemSubState = 510
                End If
            Case 510
                If (extensionSequence()) Then
                    'Hsien , used to call extension sequence  , i.e rfid read
                    systemSubState = 560
                End If
            Case 560
                loadFlags.writeFlag(flagsInLoaderUnloader.CasOn_IN_ConveyerReady_f, True)
                loadFlags.writeFlag(flagsInLoaderUnloader.LoadButtonDisable_f, False) '手動鈕致能
                systemSubState = 0
        End Select

        Return 0
    End Function
    Sub New()
        '將自定義起始化函式加入 通用起始化引動清單
        Me.initialize = [Delegate].Combine(Me.initialize, New Func(Of Integer)(AddressOf initMappingAndSetup))
    End Sub

    Function initMappingAndSetup() As Integer
        relatedFlags.AddRange(loadFlags.FlagElementsArray)
        '本站主狀態函式設定
        systemMainStateFunctions(systemStatesEnum.IGNITE) = AddressOf stateIgnite       '鍊結主狀態函式
        systemMainStateFunctions(systemStatesEnum.EXECUTE) = AddressOf stateExecuteMethod2     '鍊結主狀態函式
        systemMainState = systemStatesEnum.IGNITE   '設定初始主狀態
        'initEnableAllDrives()
        Return 0
    End Function

    Sub pauseHandler() Handles PauseBlock.InterceptedEvent, CentralAlarmObject.alarmOccured
        timer.IsEnabled = False '時間計時暫停
    End Sub
    Sub unpauseHandler() Handles PauseBlock.UninterceptedEvent, CentralAlarmObject.alarmReleased
        timer.IsEnabled = True '時間計時恢復
    End Sub
End Class

