Imports MathNet.Numerics.LinearAlgebra
Imports System.Runtime.CompilerServices
Imports System.IO
Imports MathNet.Numerics.Data.Text
Imports System.Math
''' <summary>
''' 
''' </summary>
''' <remarks></remarks>
Public Class utilities

    ''' <summary>
    ''' 3x3 Matrix
    '''               |  1     0      0     |
    ''' T_rotateX =   |  0  cos(a) -sin(a)  |
    '''               |  0  sin(a)  cos(a)  |
    ''' 
    '''               |  cos(b)  0  sin(b)  |
    ''' T_rotateY =   |    0     1    0     |
    '''               | -sin(b)  0  cos(b)  |
    ''' 
    '''               |  cos(c) -sin(c)  0  |
    ''' T_rotateZ =   |  sin(c)  cos(c)  0  |
    '''               |    0       0     1  |
    ''' </summary>
    ''' <param name="theta_x"></param>
    ''' <param name="theta_y"></param>
    ''' <param name="theta_z"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Shared Function RotateTransformation(theta_x As Double, theta_y As Double, theta_z As Double) As Matrix(Of Double)
        Dim mat_rotateX As Matrix(Of Double) = CreateMatrix.DenseOfRowArrays(Of Double)({1, 0, 0},
                                                                                        {0, Cos(theta_x), -Sin(theta_x)},
                                                                                        {0, Sin(theta_x), Cos(theta_x)})

        Dim mat_rotateY As Matrix(Of Double) = CreateMatrix.DenseOfRowArrays(Of Double)({Cos(theta_y), 0, Sin(theta_y)},
                                                                                        {0, 1, 0},
                                                                                        {-Sin(theta_y), 0, Cos(theta_y)})

        Dim mat_rotateZ As Matrix(Of Double) = CreateMatrix.DenseOfRowArrays(Of Double)({Cos(theta_z), -Sin(theta_z), 0},
                                                                                        {Sin(theta_z), Cos(theta_z), 0},
                                                                                        {0, 0, 1})
        Return mat_rotateX * mat_rotateY * mat_rotateZ
    End Function


    ''' <summary>
    ''' Error is defined by nominal-real
    ''' Given Nominal Postion , turns into Error Gain Form
    ''' { -1, 0, 0,0, -.Z, .Y,
    ''' 0, -1, 0,.Z, 0, -.X, 
    ''' 0, 0, -1,-.Y, .X, 0, }
    ''' </summary>
    ''' <param name="nominalPostion"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Shared Function position2ErrorGain(nominalPostion As PositionVector) As Matrix(Of Double)
        With nominalPostion


            Return CreateMatrix.DenseOfRowArrays(Of Double)({-1, 0, 0, 0, -.Z, .Y},
                                                            {0, -1, 0, .Z, 0, -.X},
                                                            {0, 0, -1, -.Y, .X, 0})

        End With
    End Function
    ''' <summary>
    ''' Error is defined by nominal-real
    ''' Given Nominal Postion , turns into Error Gain Form
    ''' According to nominal position's valid dimension
    ''' </summary>
    ''' <param name="nominalPostion"></param> 
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Shared Function position2ErrorGain(nominalPostion As Vector(Of Double)) As Matrix(Of Double)
        Dim __matrix = position2ErrorGain(New PositionVector(nominalPostion,
                                                              Nothing))

        Return __matrix.SubMatrix(0, nominalPostion.Count, 0, __matrix.ColumnCount)
    End Function

    Public Enum selectionEnums As Integer
        X = &H1
        Y = &H2
        Z = &H4
    End Enum
    ''' <summary>
    ''' Select the correspond error gain row
    ''' </summary>
    ''' <param name="nominalPostion"></param> 
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Shared Function position2ErrorGain(nominalPostion As Vector(Of Double),
                                              selection As selectionEnums) As Matrix(Of Double)

        Dim __matrix = position2ErrorGain(New PositionVector(nominalPostion,
                                                              Nothing))

        Dim __vectorCollection As List(Of Vector(Of Double)) = New List(Of Vector(Of Double))
        Dim values = [Enum].GetValues(GetType(selectionEnums))

        For index = 0 To values.Length - 1
            If selection And values(index) Then
                __vectorCollection.Add(__matrix.Row(index))
            End If
        Next

        Return CreateMatrix.DenseOfRowVectors(Of Double)(__vectorCollection.ToArray)
    End Function
    Public Shared Function position2ErrorGain(nominalPosition As Vector(Of Double),
                                              previousErrorVector As Vector(Of Double)) As Matrix(Of Double)

        Dim x As Double = nominalPosition(axisEntityEnum.X)
        Dim y As Double = nominalPosition(axisEntityEnum.Y)
        Dim z As Double = nominalPosition(axisEntityEnum.Z)

        Dim ca As Double = Cos(previousErrorVector(axisEntityEnum.A))
        Dim sa As Double = Sin(previousErrorVector(axisEntityEnum.A))
        Dim cb As Double = Cos(previousErrorVector(axisEntityEnum.B))
        Dim sb As Double = Sin(previousErrorVector(axisEntityEnum.B))
        Dim cc As Double = Cos(previousErrorVector(axisEntityEnum.C))
        Dim sc As Double = Sin(previousErrorVector(axisEntityEnum.C))

        Return CreateMatrix.DenseOfRowArrays(Of Double)({-1, 0, 0, 0, x * sb * cc - y * sb * sc - z * cb, x * sb * cb + y * cb * cc},
                                                        {0, -1, 0, -x * (-sa * sc + sb * ca * cc) - y * (-sa * cc - sb * sc * ca) + z * ca * cb, -x * sa * cb * cc + y * sa * sc * cb - z * sa * sb, -x * (-sa * sb * sc + ca * cc) - y * (-sa * sb * cc - sc * ca)},
                                                        {0, 0, -1, -x * (sa * sb * cc + sc * ca) - y * (-sa * sb * sc + ca * cc) + z * sa * cb, x * ca * cb * cc - y * sc * ca * cb + z * sb * ca, -x * (sa * cc + sb * sc * ca) - y * (-sa * sc + sb * ca * cc)})


    End Function


    Public Shared Function matrix2String(value As Matrix(Of Double)) As String
        Dim sw As StringWriter = New StringWriter()
        DelimitedWriter.Write(Of Double)(sw, value, ",")
        Return sw.ToString
    End Function
    Public Shared Function string2Matrix(value As String) As Matrix(Of Double)
        Dim sr As StringReader = New StringReader(value)
        Return DelimitedReader.Read(Of Double)(sr, False, ",")
    End Function

End Class
