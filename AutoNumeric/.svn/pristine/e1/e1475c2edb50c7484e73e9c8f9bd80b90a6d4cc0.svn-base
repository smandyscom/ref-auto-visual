Imports MathNet.Numerics.LinearAlgebra
Imports MathNet.Numerics.LinearAlgebra.Factorization
Imports MathNet.Spatial.Euclidean
Public Class fittingMethods


    Shared Function solveRightSingularVector(__matrix As Matrix(Of Double)) As Vector(Of Double)
        Dim __svdResult As Svd(Of Double) = __matrix.Svd()
        'find smallest singular value
        Return __svdResult.VT.Transpose.Column((__svdResult.S.AbsoluteMinimumIndex()))
    End Function

    ''' <summary>
    ''' Fit out the normal vector
    ''' ax+by+cz=0
    ''' </summary>
    ''' <param name="point3DCloud"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Shared Function normalVectorFit(point3DCloud As List(Of Vector(Of Double))) As Vector(Of Double)

        Dim coeff As Matrix(Of Double) = CreateMatrix.DenseOfArray(Of Double)({})

        'stack these vectors
        For Each item As Vector(Of Double) In point3DCloud
            coeff = coeff.Stack(item.ToRowMatrix)
        Next

        Return solveRightSingularVector(coeff).Normalize(2)
    End Function


    Shared Function origin(point3DCloud As List(Of Vector(Of Double))) As Vector(Of Double)

        Dim __accumulatedVector As Vector(Of Double) = CreateVector.Dense(Of Double)({0,
                                                                                      0,
                                                                                      0})

        For Each item As Vector(Of Double) In point3DCloud
            __accumulatedVector += item
        Next

        Return __accumulatedVector / point3DCloud.Count

    End Function

    Shared Function coordinateFind(point3DCloud As List(Of Vector(Of Double))) As htmEdgeElementary
        '1. find normal vector (Z-axis)
        '2. calculate origin (temp use)
        '3. use first point-origin vector as Y-axis(temp use)
        '4. cross out the X-axis
        '5. X-Z cross out Y-axis

        Dim zAxis As Vector(Of Double) = normalVectorFit(point3DCloud)
        Dim __origin As Vector(Of Double) = origin(point3DCloud)
        Dim tempYAxis As Vector(Of Double) = point3DCloud.First - __origin

        'cross out x-axis
        Dim xAxis As Vector(Of Double) = Vector3D.OfVector(tempYAxis).CrossProduct(Vector3D.OfVector(zAxis)).ToVector
        Dim yAxis As Vector(Of Double) = Vector3D.OfVector(xAxis).CrossProduct(Vector3D.OfVector(zAxis)).ToVector

        Dim output As htmEdgeElementary = New htmEdgeElementary(Nothing,
                                                                Nothing)
        With output
            .FrameVector(frameVectorEnum.VX) = xAxis.Normalize(2)
            .FrameVector(frameVectorEnum.VY) = yAxis.Normalize(2)
            .FrameVector(frameVectorEnum.VZ) = zAxis.Normalize(2)
            .FrameVector(frameVectorEnum.P) = __origin
        End With

        Return output
    End Function

    ''' <summary>
    ''' Planar line : y=ax+b
    ''' Planar line intersection : y=a1x+b1,y=a2x+b2
    ''' </summary>
    ''' <param name="line1Cloud"></param>
    ''' <param name="line2Cloud"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Shared Function line3DIntersection(line1Cloud As List(Of Vector(Of Double)), line2Cloud As List(Of Vector(Of Double)))
        '1. merge two cloud and find-out it local coordinate system
        '2. transform these point to local coordinate 
        '3. take the X,Y part only
        '5. do line1 ,a,b coefficient fitting
        '6. do line2 ,a,b coefficient fitting

        Dim mergedCloud As List(Of Vector(Of Double)) = New List(Of Vector(Of Double))
        mergedCloud.AddRange(line1Cloud)
        mergedCloud.AddRange(line2Cloud)

        Dim localCoordinate As htmEdgeElementary = New htmEdgeElementary(coordinateFind(mergedCloud).RawValue,
                                                                        coordinateEnums.LOCAL,
                                                                        coordinateEnums.REFERENCE)



    End Function

    Enum coordinateEnums
        LOCAL
        REFERENCE
    End Enum


End Class
