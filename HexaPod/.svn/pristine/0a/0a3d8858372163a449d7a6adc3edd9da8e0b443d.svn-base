Imports Automation.Components.CommandStateMachine
Imports System.ComponentModel
Imports Automation
Imports SmarPodAssembly
Imports System.Linq.Expressions
Imports System.Windows.Forms

Public Class userControlSmarPod
    Property _smarPod As Smarpod
    Property PropertyView As userControlPropertyView

    Dim frm As System.Windows.Forms.Form
    'Dim simultanousCommands As List(Of cMotorPoint) = New List(Of cMotorPoint)  'Hsien , 2015.01.25 , support simulatanous command

    Private Sub loadUserControl(ByVal sender As Object, ByVal e As EventArgs) Handles MyBase.Load
        'UserControlPropertyViewMotor.Drive = Motor
        Me.SplitContainer1.Panel2.Controls.Add(PropertyView)
        PropertyView.Dock = Windows.Forms.DockStyle.Fill

        For Each pair As KeyValuePair(Of [Enum], Short) In _smarPod.PositionDictionary
            ComboBox1stPositions.Items.Add(pair.Key)
        Next


        Timer1.Interval = 50
        Timer1.Enabled = True
    End Sub



    Private Sub ButtonRelMove_Click(sender As Object, e As EventArgs) Handles _
        ButtonXplus.Click, ButtonXminus.Click,
        ButtonYplus.Click, ButtonYminus.Click,
        ButtonZplus.Click, ButtonZminus.Click,
        ButtonRXplus.Click, ButtonRXminus.Click,
        ButtonRYplus.Click, ButtonRYminus.Click,
        ButtonRZplus.Click, ButtonRZminus.Click

        _smarPod.GetPose()
        _smarPod.mTargetPose.Px = _smarPod.mCurrentPose.Px
        _smarPod.mTargetPose.Py = _smarPod.mCurrentPose.Py
        _smarPod.mTargetPose.Pz = _smarPod.mCurrentPose.Pz
        _smarPod.mTargetPose.Rx = _smarPod.mCurrentPose.Rx
        _smarPod.mTargetPose.Ry = _smarPod.mCurrentPose.Ry
        _smarPod.mTargetPose.Rz = _smarPod.mCurrentPose.Rz

        Select Case sender.name
            Case ButtonXplus.Name : _smarPod.mTargetPose.Px += Val(ComboBoxRelDistance.Text)
            Case ButtonXminus.Name : _smarPod.mTargetPose.Px -= Val(ComboBoxRelDistance.Text)
            Case ButtonYplus.Name : _smarPod.mTargetPose.Py += Val(ComboBoxRelDistance.Text)
            Case ButtonYminus.Name : _smarPod.mTargetPose.Py -= Val(ComboBoxRelDistance.Text)
            Case ButtonZplus.Name : _smarPod.mTargetPose.Pz += Val(ComboBoxRelDistance.Text)
            Case ButtonZminus.Name : _smarPod.mTargetPose.Pz -= Val(ComboBoxRelDistance.Text)

            Case ButtonRXplus.Name : _smarPod.mTargetPose.Rx += Val(ComboBoxRelDegree.Text)
            Case ButtonRXminus.Name : _smarPod.mTargetPose.Rx -= Val(ComboBoxRelDegree.Text)
            Case ButtonRYplus.Name : _smarPod.mTargetPose.Ry += Val(ComboBoxRelDegree.Text)
            Case ButtonRYminus.Name : _smarPod.mTargetPose.Ry -= Val(ComboBoxRelDegree.Text)
            Case ButtonRZplus.Name : _smarPod.mTargetPose.Rz += Val(ComboBoxRelDegree.Text)
            Case ButtonRZminus.Name : _smarPod.mTargetPose.Rz -= Val(ComboBoxRelDegree.Text)

        End Select
        Dim status As Smarpod.Status = _smarPod.Move
        If status <> Smarpod.Status.SMARPOD_OK Then
            MsgBox(String.Format("Move Error : {0}", [Enum].GetName(GetType(Smarpod.Status), status)))
            _smarPod.GetPose()
            _smarPod.mTargetPose.Px = _smarPod.mCurrentPose.Px
            _smarPod.mTargetPose.Py = _smarPod.mCurrentPose.Py
            _smarPod.mTargetPose.Pz = _smarPod.mCurrentPose.Pz
            _smarPod.mTargetPose.Rx = _smarPod.mCurrentPose.Rx
            _smarPod.mTargetPose.Ry = _smarPod.mCurrentPose.Ry
            _smarPod.mTargetPose.Rz = _smarPod.mCurrentPose.Rz
        End If

    End Sub
    Private Function GetPropertyName(Of T)(prop As Expression(Of Func(Of T))) As String
        Dim expression = GetMemberInfo(prop)
        Return expression.Member.Name
    End Function
    Private Shared Function GetMemberInfo(method As Expression) As MemberExpression
        Dim lambda As LambdaExpression = TryCast(method, LambdaExpression)
        If lambda Is Nothing Then
            Throw New ArgumentNullException("method")
        End If

        Dim memberExpr As MemberExpression = Nothing

        If lambda.Body.NodeType = ExpressionType.Convert Then
            memberExpr = TryCast(DirectCast(lambda.Body, UnaryExpression).Operand, MemberExpression)
        ElseIf lambda.Body.NodeType = ExpressionType.MemberAccess Then
            memberExpr = TryCast(lambda.Body, MemberExpression)
        End If

        If memberExpr Is Nothing Then
            Throw New ArgumentException("method")
        End If

        Return memberExpr
    End Function

    Private Sub btnConnect_Click(sender As Object, e As EventArgs) Handles btnConnect.Click
        _smarPod.Connect(_smarPod.mModelNum, _smarPod.mLocator)
        _smarPod.GetPose()
        _smarPod.mTargetPose.Px = _smarPod.mCurrentPose.Px
        _smarPod.mTargetPose.Py = _smarPod.mCurrentPose.Py
        _smarPod.mTargetPose.Pz = _smarPod.mCurrentPose.Pz
        _smarPod.mTargetPose.Rx = _smarPod.mCurrentPose.Rx
        _smarPod.mTargetPose.Ry = _smarPod.mCurrentPose.Ry
        _smarPod.mTargetPose.Rz = _smarPod.mCurrentPose.Rz

    End Sub

    Private Sub ButtonMoveToZero_Click(sender As Object, e As EventArgs) Handles ButtonMoveToZero.Click
        With _smarPod.mTargetPose
            .Px = 0
            .Py = 0
            .Pz = 0
            .Rx = 0
            .Ry = 0
            .Rz = 0
        End With
        Dim status As Smarpod.Status = _smarPod.Move
        If status <> Smarpod.Status.SMARPOD_OK Then
            _smarPod.Move()
            MsgBox(String.Format("Move Error : {0}", [Enum].GetName(GetType(Smarpod.Status), status)))
        End If

    End Sub

    Private Sub ButtonFindReferenceMark_Click(sender As Object, e As EventArgs) Handles ButtonFindReferenceMark.Click
        _smarPod.FindReferenceMarks()
    End Sub

    Private Sub Timer1_Tick(sender As Object, e As EventArgs) Handles Timer1.Tick
        _smarPod.GetPose()
        TextBox_Px.Text = Format(_smarPod.mCurrentPose.Px, "0.00")
        TextBox_Py.Text = Format(_smarPod.mCurrentPose.Py, "0.00")
        TextBox_Pz.Text = Format(_smarPod.mCurrentPose.Pz, "0.00")
        TextBox_Rx.Text = Format(_smarPod.mCurrentPose.Rx, "0.000")
        TextBox_Ry.Text = Format(_smarPod.mCurrentPose.Ry, "0.000")
        TextBox_Rz.Text = Format(_smarPod.mCurrentPose.Rz, "0.000")
    End Sub

    Private Sub ButtonMove_Click(sender As Object, e As EventArgs) Handles ButtonMove.Click
        Dim endStatus = _smarPod.CommandEndStatus 'reset it
        If (ComboBox1stPositions.SelectedItem IsNot Nothing) Then
            _smarPod.drive(ComboBoxCommand.SelectedItem, ComboBox1stPositions.SelectedItem)
        Else
            _smarPod.drive(ComboBoxCommand.SelectedItem)
        End If

    End Sub
End Class
