Imports MathNet.Numerics.LinearAlgebra
Imports AutoNumeric
Imports Automation
Imports Cognex.VisionPro.ToolBlock
Imports Cognex.VisionPro

Imports System.Xml.Serialization
Imports System.IO


Public Class imageProcessEndEventArgs
    Inherits EventArgs

    ReadOnly Property OutputPosition As Vector(Of Double)
        Get
            'TODO, handling process
            Return CreateVector.Dense(Of Double)(3)
        End Get
    End Property
    ReadOnly Property Result As CogToolResultConstants
        Get
            Return __result.Result
        End Get
    End Property

    Dim __outputPosition As CogToolBlockTerminalCollection = Nothing
    Dim __result As ICogRunStatus = Nothing

    Sub New(ByVal outputPosition As CogToolBlockTerminalCollection,
            result As ICogRunStatus)
        Me.__outputPosition = outputPosition
        Me.__result = result
    End Sub

End Class

''' <summary>
''' Used to trigger camera
''' </summary>
''' <remarks></remarks>
Public Class imageProcessTriggerEventArgs
    Inherits EventArgs

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="sender"></param>
    ''' <param name="e"></param>
    ''' <remarks></remarks>
    Public Event ImageProcessDone(ByVal sender As Object, ByVal e As EventArgs)

    ''' <summary>
    ''' The cognex tool block object
    ''' Contains some specific image process flow
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    ReadOnly Property ToolBlock As CogToolBlock
        Get
            Return __toolBlock
        End Get
    End Property

    Dim WithEvents __toolBlock As CogToolBlock = Nothing

    Sub New(__toolBlock As CogToolBlock)
        Me.__toolBlock = __toolBlock
    End Sub

    ''' <summary>
    ''' Regular the interface
    ''' </summary>
    ''' <remarks></remarks>
    Protected Sub toolBlockExecuted(sender As Object, e As EventArgs) Handles __toolBlock.Ran

        With __toolBlock
            RaiseEvent ImageProcessDone(Me, New imageProcessEndEventArgs(.Outputs,
                                                                         .RunStatus))

        End With

    End Sub

    ''' <summary>
    ''' Mount on source event
    ''' </summary>
    ''' <param name="sender"></param>
    ''' <param name="e"></param>
    ''' <remarks></remarks>
    Public Shared Sub toolBlockExecute(sender As Object, e As imageProcessTriggerEventArgs)
        '------------------
        '   Initiate Runing
        '------------------
        e.ToolBlock.Run()
    End Sub


End Class


''' <summary>
''' 
''' </summary>
''' <remarks></remarks>
<Serializable()>
Public Class cameraCalibrationSetting
    Inherits settingBase

    ReadOnly Property Reference As framesDefinition
        Get
            Return __reference
        End Get
    End Property
    Dim __reference As framesDefinition = framesDefinition.C1REAL

    Property CenterText As String
        Get
            Return centerPosition.PositionText
        End Get
        Set(value As String)
            centerPosition = New PositionVector(__reference)
            centerPosition.PositionText = value
        End Set
    End Property
    Dim centerPosition As PositionVector = New PositionVector(Nothing)

    ''' <summary>
    ''' In mm
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Property Radius As Double = 2
    ''' <summary>
    ''' How many points should be generated
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Property Divides As Integer = 10

    ''' <summary>
    ''' Generate Points according to setting
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    ReadOnly Property MeasurePoints As List(Of PositionVector)
        Get
            Dim outputList As List(Of PositionVector) = New List(Of PositionVector)
            Dim outputPoint As PositionVector = Nothing

            Dim radIncrement As Double = 2 * Math.PI / Divides
            Dim radAccumulate As Double = 0

            For index = 0 To Divides - 1
                outputPoint = New PositionVector(Reference)
                With outputPoint
                    .X = centerPosition.X + Radius * Math.Cos(radAccumulate)
                    .Y = centerPosition.Y + Radius * Math.Sin(radAccumulate)
                    .Z = 0
                End With
                radAccumulate += radIncrement

                outputList.Add(outputPoint)
            Next
            Return outputList
        End Get
    End Property
    ''' <summary>
    ''' 
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Property ImageProcessSetting As imageProcessSettingBlock = Nothing

    <XmlIgnore()>
    Public Overrides Property Filename As String
        Get
            If Not Directory.Exists(settingPath) Then
                Directory.CreateDirectory(settingPath)
            End If

            Return String.Format("{0}{1}.xml",
                                 settingPath,
                                 Me.ToString)
        End Get
        Set(value As String)
            'nothing to do
        End Set
    End Property

    Shared settingPath As String = My.Application.Info.DirectoryPath & "\Data\calibration\"

    Sub New(__reference As framesDefinition)
        Me.__reference = __reference
        Me.ImageProcessSetting = New imageProcessSettingBlock(__reference)
    End Sub
    ''' <summary>
    ''' For loading use
    ''' </summary>
    ''' <remarks></remarks>
    Public Sub New()

    End Sub

    Public Overrides Function ToString() As String
        Return String.Format("{0}_{1}",
                             __reference.ToString,
                             Me.GetType.ToString)
    End Function

#Region "persistance"
    Public Overrides Sub Load(filename As String)
        MyBase.Load(filename)
        'TODO , solve dependency issue
        Try
            Me.applyPropertyChange() ' after loaded , transmit setting
        Catch ex As Exception
        End Try
    End Sub
    Public Overrides Sub Save()
        MyBase.Save()
    End Sub
#End Region

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <remarks></remarks>
    Sub settingChanged() Handles MyBase.PropertyChanged
        'reload the cog tool block
        ImageProcessSetting.applyPropertyChange()
    End Sub


End Class

Public Class imageProcessSettingBlock
    Inherits settingBase

    Public Overrides Property Filename As String
        Get
            If Not Directory.Exists(vppPath) Then
                Directory.CreateDirectory(vppPath)
            End If
            Return String.Format("{0}{1}.vpp",
                                 vppPath,
                                 Me.ToString)
        End Get
        Set(value As String)

        End Set
    End Property


    ReadOnly Property ToolBlock As CogToolBlock
        Get
            Return __toolBlock
        End Get
    End Property
    ''' <summary>
    ''' In percentage representation
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Property LightDensity As Double = 1.0F

    Shared vppPath As String = My.Application.Info.DirectoryPath & "\Data\vpps\"

    Dim __toolBlock As CogToolBlock = Nothing
    ''' <summary>
    ''' 
    ''' </summary>
    ''' <remarks></remarks>
    Sub reloadVppObject(sender As Object, e As EventArgs) Handles Me.PropertyChanged
        'Load cog block
        __toolBlock = TryCast(CogSerializer.LoadObjectFromFile(Me.Filename), CogToolBlock)
        If __toolBlock Is Nothing Then
            MessageBox.Show(String.Format("vpp loading failed, {0}",
                                           Me.Filename))
        End If
    End Sub

    Sub New(Optional tag As Object = "default")
        Me.tag = tag
    End Sub
    ''' <summary>
    ''' For loading use
    ''' </summary>
    ''' <remarks></remarks>
    Protected Sub New()

    End Sub

    Dim tag As Object = "default"
    Public Overrides Function ToString() As String
        Return String.Format("{0}_{1}",
                             tag,
                             Me.GetType.ToString)
    End Function
End Class