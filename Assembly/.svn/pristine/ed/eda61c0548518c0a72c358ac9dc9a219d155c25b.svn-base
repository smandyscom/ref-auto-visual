Imports AutoNumeric
Imports Cognex.VisionPro.ToolBlock
Imports MathNet.Numerics.LinearAlgebra
Imports AutoNumeric.utilities
Imports System.Xml.Serialization
Imports System.IO

''' <summary>
''' Feature(surface) measurement procedure and related settings
''' </summary>
''' <remarks></remarks>
Public Class lpcFeatureMeasureSetting
    Inherits imageProcessSettingBlock

    Protected readyPosition As itemsDefinition = itemsDefinition.CHOKE_CENTER
    Protected __featurePoint As itemsDefinition = itemsDefinition.LPC_F1

    Protected cameraFrameIdeal As framesDefinition = framesDefinition.C1
    Protected cameraFrameReal As framesDefinition = framesDefinition.C1REAL

    Protected interestedFeatures As List(Of itemsDefinition) = New List(Of itemsDefinition)
    Protected dimensionSelection As Integer = selectionEnums.X Or selectionEnums.Y

    Friend __outputList As List(Of measuredDataPair) = New List(Of measuredDataPair)


    Function procedure(ByRef state As Integer) As Boolean
        With frames.Instance
            Select Case state
                Case 0
                    'move to ready position for X stage
                    .CurrentMovingItem = framesDefinition.S0
                    .CurrentRItem = readyPosition
                    Me.__outputList.Clear()
                    state += 10
                Case 10
                    'align the feature center
                    If Assembly.Instance.IsAllAxesSettled Then

                        Dim targetTransformation As htmEdgeElementary = New htmEdgeElementary(framesDefinition.LPC_REAL,
                                                                                              cameraFrameReal)
                        Dim featurePointCoordinate As htmEdgeElementary = New htmEdgeElementary(framesDefinition.LPC_REAL,
                                                                                                framesDefinition.LPC_REAL) With {.PositionVector = frames.Instance.objectsDictionary(__featurePoint).RawValue}

                        With targetTransformation
                            ''origin coincidence
                            '.Origin = targetTransformation * New PositionVector(frames.Instance.objectsDictionary(__featurePoint).RawValue * -1, framesDefinition.LPC_REAL)
                            'go to the nominal pose
                            .RotationMatrix = frames.Instance.Transformation(framesDefinition.LPC,
                                                                                       cameraFrameIdeal).RotationMatrix
                        End With
                        targetTransformation = targetTransformation * featurePointCoordinate.Inverse

                        'would auto compensate pose-error , move real frame to meet the nominal pose
                        .solveS(targetTransformation)
                        state += 10
                    Else
                        '--------------------
                        '   Settling
                        '--------------------
                    End If
                Case 20
                    If Assembly.Instance.CommandEndStatus(controlUnitsEnum.S) =
                        Automation.IDrivable.endStatus.EXECUTION_END Then

                        'initiating measuring procedure
                        '-------------------------------------------------------
                        '   Image Processing
                        '-------------------------------------------------------
                        onCameraTriggered()
                        state = 100
                    Else
                        '--------------
                        '   Moving
                        '--------------
                    End If
                Case 100
                    If IsImageProcessDone And
                        Result = Cognex.VisionPro.CogToolResultConstants.Accept Then
                        'take measured value/nominal value into list
                        'there's one dimension missing on camera


                        If Result = Cognex.VisionPro.CogToolResultConstants.Accept Then
                            For index = 0 To interestedFeatures.Count - 1
                                'error on LPC-REAL_Frame
                                Dim nominalValue = .objectsDictionary(interestedFeatures(index))
                                Dim realValue = .Transformation(cameraFrameReal, framesDefinition.LPC_REAL) * New PositionVector(Coordinates(index), cameraFrameReal)

                                __outputList.Add(New measuredDataPair(nominalValue.RawValue,
                                                                    realValue.RawValue,
                                                                    dimensionSelection))

                            Next
                        Else
                            '--------------------
                            'Image Process Failed
                            '--------------------
                        End If


                        '------------------------
                        '   Back to safe position
                        '------------------------
                        sHtm.Instance.ControlVector = sHtm.Instance.SafePose.Clone
                        state = 500
                    Else
                        '------------------
                        '   Camera working
                        '-----------------
                    End If
                    '-----------------------------
                    '   Wait Smodpod Return
                    '-----------------------------
                Case 500
                    If Assembly.Instance.CommandEndStatus(controlUnitsEnum.S) =
                         Automation.IDrivable.endStatus.EXECUTION_END Then
                        Return True
                    Else
                        '----------------
                        '
                        '----------------
                    End If
            End Select

        End With

        Return False
    End Function

    Sub New(__featurePoint As itemsDefinition)

        Me.__featurePoint = __featurePoint
        Select Case __featurePoint
            Case itemsDefinition.LPC_F1
                readyPosition = itemsDefinition.CHOKE_CENTER
                cameraFrameIdeal = framesDefinition.C1
                cameraFrameReal = framesDefinition.C1REAL
                With interestedFeatures
                    .Add(itemsDefinition.LPC_R1)
                    .Add(itemsDefinition.LPC_R2)
                End With
                dimensionSelection = selectionEnums.Y Or selectionEnums.Z
            Case itemsDefinition.LPC_F2
                readyPosition = itemsDefinition.CHOKE_CENTER
                cameraFrameIdeal = framesDefinition.C2
                cameraFrameReal = framesDefinition.C2REAL
                With interestedFeatures
                    .Add(itemsDefinition.LPC_R2)
                    .Add(itemsDefinition.LPC_R3)
                End With
                dimensionSelection = selectionEnums.X Or selectionEnums.Z
            Case itemsDefinition.LPC_F3
                readyPosition = itemsDefinition.C3_ORIGIN
                cameraFrameIdeal = framesDefinition.C3
                cameraFrameReal = framesDefinition.C3REAL
                With interestedFeatures
                    .Add(itemsDefinition.LPC_R1)
                    .Add(itemsDefinition.LPC_R4)
                    .Add(itemsDefinition.LPC_R2)
                    .Add(itemsDefinition.LPC_R3)
                    '.Add(itemsDefinition.LPC_H1)
                    '.Add(itemsDefinition.LPC_H2)
                End With
                dimensionSelection = selectionEnums.X Or selectionEnums.Y
        End Select


    End Sub
    Public Sub New()

    End Sub


#Region "persistance"
    Shared settingPath As String = My.Application.Info.DirectoryPath & "\Data\feature\"
    <XmlIgnore()>
    Public Overrides Property Filename As String
        Get
            If Not Directory.Exists(settingPath) Then
                Directory.CreateDirectory(settingPath)
            End If

            Return String.Format("{0}{1}.xml",
                                 settingPath,
                                 Me.ToString)
        End Get
        Set(value As String)
            'nothing to do
        End Set
    End Property

    Public Overrides Sub Load(filename As String)
        MyBase.Load(filename)
        Try
            Me.applyPropertyChange() ' after loaded , transmit setting
        Catch ex As Exception
        End Try
    End Sub
    Public Overrides Sub Save()
        MyBase.Save()
    End Sub
    Public Overrides Function ToString() As String
        Return String.Format("{0}_{1}",
                             Me.__featurePoint.ToString,
                             Me.GetType.ToString)
    End Function
#End Region

End Class


''' <summary>
''' 1.Align F1 to C1 , measure R1,R2
''' 2.Align F2 to C2 , meausre R2,R3
''' 3.Align F3 to C3 (Orientation need) , measure R1,R2,R3,H1,H2
''' 4. Do error fitting
''' 5. Do step 1-4 until error vector converged 
''' </summary>
''' <remarks></remarks>
Public Class lpcMark
    Inherits measureProcedureType1Base
    Implements IDisposable

    Friend featureMeasureSettings As Dictionary(Of itemsDefinition, lpcFeatureMeasureSetting) =
        New Dictionary(Of itemsDefinition, lpcFeatureMeasureSetting)

    Protected featureProcedureState As Integer = 0
    Protected currentFeatureProcedure As Dictionary(Of itemsDefinition, lpcFeatureMeasureSetting).Enumerator = Nothing
    ''' <summary>
    ''' 1. move X
    ''' 2. align center by S
    ''' 3. measure features , output pairs
    ''' </summary>
    ''' <param name="state"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Protected Overrides Function measureProcedure(ByRef state As Integer) As Boolean

        Select Case state
            Case 0
                currentFeatureProcedure = featureMeasureSettings.GetEnumerator
                state = 10
            Case 10
                If currentFeatureProcedure.MoveNext Then
                    state = 100
                Else
                    '-----------------------
                    '   All feature executed
                    '-----------------------
                    Return True
                End If
            Case 100
                With currentFeatureProcedure.Current.Value
                    If .procedure(featureProcedureState) Then
                        featureProcedureState = 0 'rewind
                        dataPairCollection.AddRange(.__outputList)
                        state = 10
                    Else
                        '-----------------------
                        '   Procedure is running
                        '-----------------------    
                    End If
                End With
        End Select

        Return False

    End Function

    Protected Overrides Function preparationProcedure(ByRef state As Integer) As Boolean
        'clear lpc real
        Return True
    End Function


    Protected Sub New()
        With featureMeasureSettings
            For Each item As itemsDefinition In {itemsDefinition.LPC_F1,
                                                  itemsDefinition.LPC_F2,
                                                  itemsDefinition.LPC_F3}
                .Add(item, New lpcFeatureMeasureSetting(item))

            Next

            For Each item As KeyValuePair(Of itemsDefinition, lpcFeatureMeasureSetting) In .ToList
                item.Value.Load(Nothing)
            Next

        End With

        'all calculation used to mark the lpcreal
        correspondingErrorMatrix = frames.Instance.Elementray(framesDefinition.LPC_REAL,
                                                              framesDefinition.LPC)
        'LPC_REAL_1 to LPC_REAL_0
        Me.errorMatrix = New eulerHtmTR(framesDefinition.LPC_REAL,
                                        framesDefinition.LPC_REAL)
        'handling method 
        Me.compenstationMethod = compenstationMethodEnums.AS_PASSIVE_OBJECT
    End Sub


#Region "singleton interface"
    ''' <summary>
    ''' Singalton pattern
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Shared ReadOnly Property Instance As lpcMark
        Get
            If __instance Is Nothing Then
                __instance = New lpcMark
            End If
            Return __instance
        End Get
    End Property
    Shared __instance As lpcMark = Nothing
#End Region

#Region "IDisposable Support"
    Private disposedValue As Boolean ' To detect redundant calls

    ' IDisposable
    Protected Overridable Sub Dispose(disposing As Boolean)
        If Not Me.disposedValue Then
            If disposing Then
            End If

            For Each item As KeyValuePair(Of itemsDefinition, lpcFeatureMeasureSetting) In featureMeasureSettings.ToList
                item.Value.Save()
            Next
        End If
        Me.disposedValue = True
    End Sub

    Protected Overrides Sub Finalize()
        ' Do not change this code.  Put cleanup code in Dispose(ByVal disposing As Boolean) above.
        Dispose(False)
        MyBase.Finalize()
    End Sub

    ' This code added by Visual Basic to correctly implement the disposable pattern.
    Public Sub Dispose() Implements IDisposable.Dispose
        ' Do not change this code.  Put cleanup code in Dispose(disposing As Boolean) above.
        Dispose(True)
        GC.SuppressFinalize(Me)
    End Sub
#End Region

End Class
