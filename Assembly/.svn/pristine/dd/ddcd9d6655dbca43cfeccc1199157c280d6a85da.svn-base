Imports AutoNumeric

Public Class c4CalibrationSetting
    Inherits cameraCalibrationSettingBase

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Property C3ImageProcessSetting As imageProcessSettingBlock = Nothing

    Sub New()
        MyBase.New(framesDefinition.Y0REAL,
                   framesDefinition.Y0)
        C3ImageProcessSetting = New imageProcessSettingBlock("ballOnc3")
    End Sub



End Class

Public Class c4CalibrationProcedure
    Inherits cameraCalibrationBase

    Dim ballRealPosition As PositionVector = New PositionVector(framesDefinition.R)
    Dim WithEvents c3TriggerHandle As imageProcessTriggerEventArgs = Nothing

    Public Overrides Sub moveAction()
        'move current position under views of C4
        frames.Instance.solveAbsAxAy(nominalPosition.Current)
    End Sub

    Public Overrides Sub settingSaveAction()
        CurrentTarget.Save()
    End Sub

    ''' <summary>
    ''' In order to sort out Y0REAL , 
    ''' turns nominal points on Y0
    ''' turns real point on Y0REAL
    ''' </summary>
    ''' <remarks></remarks>
    Public Overrides Function postHandlingAction() As measuredDataPair
        With frames.Instance
            Dim real As PositionVector = .Transformation(framesDefinition.R, framesDefinition.Y0REAL) * ballRealPosition
            Dim nominal As PositionVector = .Transformation(framesDefinition.C4, framesDefinition.Y0REAL) * New PositionVector(doneHandle.OutputPosition, framesDefinition.C4)
            Return New measuredDataPair(nominal.RawValue.SubVector(0, 2),
                                        real.RawValue.SubVector(0, 2))
        End With
    End Function

    Public Overrides Function preparationProcedure(ByRef state As Integer) As Boolean
        '-------------------------
        '   Take Real Ball Position On FOV of C3
        '-------------------------
        Select Case state
            Case 0
                With frames.Instance
                    .CurrentMovingItem = framesDefinition.C4
                    .CurrentRItem = itemsDefinition.C3_ORIGIN
                End With
                state = 10
            Case 10
                If Assembly.Instance.IsAllAxesSettled Then
                    c3TriggerHandle = New imageProcessTriggerEventArgs(CurrentTarget.ImageProcessSetting.ToolBlock)
                    onCameraTriggerd(c3TriggerHandle)
                    state = 100
                Else
                    '------------------
                    '   Axes Moving
                    '------------------
                End If
            Case 100
                '--------------
                '   Finished when camera worked 
                '--------------
                Return Not __isCameraTriggerd
        End Select

        Return False
    End Function

#Region "singleton interface"
    ''' <summary>
    ''' Singalton pattern
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Shared ReadOnly Property Instance As c4CalibrationProcedure
        Get
            If __instance Is Nothing Then
                __instance = New c4CalibrationProcedure
            End If
            Return __instance
        End Get
    End Property
    Shared __instance As c4CalibrationProcedure = Nothing
#End Region

    Protected Sub New()
        Me.initialize = [Delegate].Combine(Me.initialize,
                                           New Func(Of Integer)(AddressOf initMappingAndSetup))
    End Sub
    Function initMappingAndSetup() As Integer
        '------------------------
        '   Loading Setting Files
        '------------------------
        CurrentTarget = New c4CalibrationSetting()
        CurrentTarget.Load(Nothing)
        Return 0
    End Function

    Protected Overrides Sub imageProcessDone(sender As Object, e As imageProcessEndEventArgs) Handles c3TriggerHandle.ImageProcessDone
        '------------------------------------
        '   Calculating out the real position
        '------------------------------------
        ballRealPosition = frames.Instance.Transformation(framesDefinition.C3, framesDefinition.R) *
            New PositionVector(e.OutputPosition, framesDefinition.C3REAL)

        MyBase.imageProcessDone(sender, e)
    End Sub


End Class
